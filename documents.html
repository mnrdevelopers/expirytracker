<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Documents - Expiry Tracker</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">

     <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>
</head>
<body>
    <!-- Header -->
    <header>
        <div class="container">
            <nav class="navbar">
                <a href="dashboard.html" class="logo">üìÖ Expiry Tracker</a>
                <ul class="nav-links">
                    <li><a href="dashboard.html">Dashboard</a></li>
                    <li><a href="documents.html" class="active">Documents</a></li>
                    <li><a href="add-document.html">Add Document</a></li>
                    <li><a href="settings.html">Settings</a></li>
                </ul>
                <div class="user-info">
                    <span class="user-email" id="user-email"></span>
                    <button class="btn btn-outline" id="logout-btn">Logout</button>
                </div>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container">
        <div id="documents-page" class="page">
            <div class="documents-header">
                <h1 class="page-title">My Documents</h1>
                <a href="add-document.html" class="btn btn-primary">Add Document</a>
            </div>
            
            <div id="documents-list" class="documents-grid">
                <div class="empty-state">
                    <h3>No documents yet</h3>
                    <p>Start by adding your first document to track its expiry.</p>
                    <a href="add-document.html" class="btn btn-primary">Add Your First Document</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Document Modal -->
    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Edit Document</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="edit-document-form">
                    <input type="hidden" id="edit-doc-id">
                    <div class="form-group">
                        <label for="edit-doc-type">Document Type</label>
                        <select id="edit-doc-type" class="form-control" required>
                            <option value="">Select document type</option>
                            <option value="Vehicle RC">Vehicle RC</option>
                            <option value="Driving License">Driving License</option>
                            <option value="Passport">Passport</option>
                            <option value="Insurance">Insurance</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="edit-doc-name">Document Name / Title</label>
                        <input type="text" id="edit-doc-name" class="form-control" placeholder="Enter document name" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-doc-number">Document Number</label>
                        <input type="text" id="edit-doc-number" class="form-control" placeholder="Enter document number" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-issue-date">Issue Date</label>
                        <input type="date" id="edit-issue-date" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-expiry-date">Expiry Date</label>
                        <input type="date" id="edit-expiry-date" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-notes">Notes (Optional)</label>
                        <textarea id="edit-notes" class="form-control" rows="3" placeholder="Add any additional notes"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="cancel-edit">Cancel</button>
                <button class="btn btn-primary" id="save-edit">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="delete-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Confirm Delete</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this document? This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="cancel-delete">Cancel</button>
                <button class="btn btn-danger" id="confirm-delete">Delete</button>
            </div>
        </div>
    </div>

    <!-- Loading Indicator -->
    <div id="loading" class="loading hidden">
        <div class="spinner"></div>
    </div>

    <script src="firebase-config.js"></script>
    <script src="script.js"></script>
    <script>
        // Documents page specific functionality
        document.addEventListener('DOMContentLoaded', function() {
            const logoutBtn = document.getElementById('logout-btn');
            const documentsList = document.getElementById('documents-list');
            const editModal = document.getElementById('edit-modal');
            const deleteModal = document.getElementById('delete-modal');
            let documentToDelete = null;
            
            if (logoutBtn) {
                logoutBtn.addEventListener('click', function() {
                    firebase.auth().signOut().then(() => {
                        window.location.href = 'index.html';
                    });
                });
            }
            
            // Check auth state
            firebase.auth().onAuthStateChanged((user) => {
                if (!user) {
                    window.location.href = 'index.html';
                } else {
                    document.getElementById('user-email').textContent = user.email;
                }
            });
            
            // Set up real-time documents listener
            let unsubscribeDocuments = null;
            let documents = [];
            
            function setupDocumentsListener() {
                const user = firebase.auth().currentUser;
                if (!user) return;
                
                unsubscribeDocuments = firebase.firestore().collection('documents')
                    .where('userId', '==', user.uid)
                    .orderBy('expiryDate', 'asc')
                    .onSnapshot((snapshot) => {
                        documents = [];
                        snapshot.forEach(doc => {
                            const data = doc.data();
                            documents.push({
                                id: doc.id,
                                ...data,
                                expiryDate: data.expiryDate?.toDate ? data.expiryDate.toDate() : new Date(data.expiryDate),
                                issueDate: data.issueDate?.toDate ? data.issueDate.toDate() : new Date(data.issueDate)
                            });
                        });
                        
                        renderDocuments();
                    });
            }
            
            function renderDocuments() {
                if (!documentsList) return;
                
                documentsList.innerHTML = '';
                
                if (documents.length === 0) {
                    documentsList.innerHTML = `
                        <div class="empty-state" style="grid-column: 1 / -1;">
                            <h3>No documents yet</h3>
                            <p>Start by adding your first document to track its expiry.</p>
                            <a href="add-document.html" class="btn btn-primary">Add Your First Document</a>
                        </div>
                    `;
                    return;
                }
                
                documents.forEach(doc => {
                    const status = getDocumentStatus(doc.expiryDate);
                    const daysRemaining = getDaysRemaining(doc.expiryDate);
                    
                    const documentCard = document.createElement('div');
                    documentCard.className = `document-card ${status}`;
                    documentCard.innerHTML = `
                        <div class="document-type">${doc.type}</div>
                        <div class="document-name">${doc.name}</div>
                        <div class="document-number">${doc.number}</div>
                        <div class="document-expiry">
                            <div>Expires: ${formatDate(doc.expiryDate)}</div>
                            <div class="days-badge ${status}">${daysRemaining > 0 ? `${daysRemaining} days` : 'Expired'}</div>
                        </div>
                        <div class="document-actions">
                            <button class="action-btn edit-doc" data-id="${doc.id}" title="Edit">‚úèÔ∏è</button>
                            <button class="action-btn delete-doc" data-id="${doc.id}" title="Delete">üóëÔ∏è</button>
                        </div>
                    `;
                    
                    documentsList.appendChild(documentCard);
                });
                
                // Add event listeners to edit and delete buttons
                document.querySelectorAll('.edit-doc').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const docId = e.target.closest('button').getAttribute('data-id');
                        openEditModal(docId);
                    });
                });
                
                document.querySelectorAll('.delete-doc').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const docId = e.target.closest('button').getAttribute('data-id');
                        openDeleteModal(docId);
                    });
                });
            }
            
            function openEditModal(docId) {
                const doc = documents.find(d => d.id === docId);
                if (!doc) return;
                
                document.getElementById('edit-doc-id').value = doc.id;
                document.getElementById('edit-doc-type').value = doc.type;
                document.getElementById('edit-doc-name').value = doc.name;
                document.getElementById('edit-doc-number').value = doc.number;
                document.getElementById('edit-issue-date').value = formatDateForInput(doc.issueDate);
                document.getElementById('edit-expiry-date').value = formatDateForInput(doc.expiryDate);
                document.getElementById('edit-notes').value = doc.notes || '';
                
                editModal.style.display = 'flex';
            }
            
            function openDeleteModal(docId) {
                documentToDelete = docId;
                deleteModal.style.display = 'flex';
            }
            
            // Modal event listeners
            document.querySelectorAll('.close-modal').forEach(btn => {
                btn.addEventListener('click', () => {
                    editModal.style.display = 'none';
                    deleteModal.style.display = 'none';
                    documentToDelete = null;
                });
            });
            
            document.getElementById('cancel-edit').addEventListener('click', () => {
                editModal.style.display = 'none';
            });
            
            document.getElementById('save-edit').addEventListener('click', handleSaveEdit);
            
            document.getElementById('cancel-delete').addEventListener('click', () => {
                deleteModal.style.display = 'none';
                documentToDelete = null;
            });
            
            document.getElementById('confirm-delete').addEventListener('click', handleConfirmDelete);
            
            // Close modals when clicking outside
            window.addEventListener('click', (e) => {
                if (e.target === editModal) {
                    editModal.style.display = 'none';
                }
                if (e.target === deleteModal) {
                    deleteModal.style.display = 'none';
                    documentToDelete = null;
                }
            });
            
            function handleSaveEdit() {
                const docId = document.getElementById('edit-doc-id').value;
                const docData = {
                    type: document.getElementById('edit-doc-type').value,
                    name: document.getElementById('edit-doc-name').value,
                    number: document.getElementById('edit-doc-number').value,
                    issueDate: document.getElementById('edit-issue-date').value,
                    expiryDate: document.getElementById('edit-expiry-date').value,
                    notes: document.getElementById('edit-notes').value,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                showLoading();
                
                firebase.firestore().collection('documents').doc(docId).update(docData)
                    .then(() => {
                        hideLoading();
                        editModal.style.display = 'none';
                    })
                    .catch(error => {
                        hideLoading();
                        console.error('Error updating document: ', error);
                        alert('Error updating document: ' + error.message);
                    });
            }
            
            function handleConfirmDelete() {
                if (!documentToDelete) return;
                
                showLoading();
                
                firebase.firestore().collection('documents').doc(documentToDelete).delete()
                    .then(() => {
                        hideLoading();
                        deleteModal.style.display = 'none';
                        documentToDelete = null;
                    })
                    .catch(error => {
                        hideLoading();
                        console.error('Error deleting document: ', error);
                        alert('Error deleting document: ' + error.message);
                    });
            }
            
            function formatDateForInput(date) {
                if (!date) return '';
                const dateObj = date instanceof Date ? date : new Date(date);
                return dateObj.toISOString().split('T')[0];
            }
            
            function showLoading() {
                const loading = document.getElementById('loading');
                if (loading) loading.classList.remove('hidden');
            }
            
            function hideLoading() {
                const loading = document.getElementById('loading');
                if (loading) loading.classList.add('hidden');
            }
            
            // Initialize documents listener
            setupDocumentsListener();
        });
    </script>
</body>
</html>
